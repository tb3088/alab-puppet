---
lookup_options:
  '^gsajboss6::(user|group|dirs)$':
    merge: 'hash'
  '^gsajboss6::install::(.*)$':
    merge: 'hash'

#FIXME

# 1. 'sw' is gratuitous
# 2. adopt JBOSS_HOME=/opt/jboss/[jboss-]eap-x.y (shared).
# instances should have:
# CONFIG in [/usr/local]/etc/jboss/<instance> and
# WAR in /var/lib/jboss/<instance> and
# LOGS in /var/log/jboss/<instance>
#
# arguably _BASE = /var/lib/jboss/<instance> 
# 3. JAVA_HOME if 3rd party should be /opt/java/<version>

# TODO
# use stdlib::file_line resource to rewrite GSA's rc_scripts/config_jboss_example.sh with less stupid.
# actually just rewrite them all so they pick up on naming: <config|start|stop|restart>_[jboss_]<instance>.sh

#lookup_options:
#  key:
#    merge: see https://puppet.com/docs/puppet/5.4/hiera_merging.html#merge-behaviors

# NOTICE!!
# While 'lookup()' can return a Hash/Array natively, the right-hand-side of YAML items has to be a String-like
# object so 'storing' it in YAML for purposes of 'Automatic Parameter Lookup (APL)' force-converts it to String which
# will then violate Class parameter datatypes if not also set to receive a String. You have to instead put 'lookup()' 
# in the Class parameter section explicitly. Otherwise the Hash/Array has to spelled out in proper YAML format.
#
# CAN NOT DO THIS!!
#gsajboss6::user:    "%{lookup('os::users.jboss', Hash)}"
#gsajboss6::group:   %{lookup('os::groups.jboss')}

gsajboss6::group:
  name: 'jboss'
  gid:  201

gsajboss6::user:
  name: 'jboss'
  uid:  201
  gid:  "%{lookup('gsajboss6::group.gid')}"
  home: "%{lookup('os::dirs.home.path')}/jboss"
  shell: "%{lookup('os::default.shell')}"
  comment:

# These are HIERA self-referential workaround, do NOT use in manifests!
#FIXME should be %{lookup('os::dirs.opt.path')}/$product/$version
gsajboss6::root_dir: '/opt/sw/jboss'

# APL friendly, flattened
gsajboss6::install::product: 'jboss-eap'
gsajboss6::install::version: 6.4
#FIXME should be .../[$moduleName]/$product/$version
gsajboss6::install::source: "%{lookup('buckets.software')}/jboss"

#TODO an array of strings
gsajboss6::install::package:
    "gsainstall-%{lookup('gsajboss6::install::version')}-2.%{facts.os.architecture}"
#TODO an array of hashes {name: filename, destdir: blah}
gsajboss6::install::file:
    "%{lookup('gsajboss6::install::product')}-%{lookup('gsajboss6::install::version')}_update5.zip"
gsajboss6::install::destdir:
    "%{lookup('gsajboss6::root_dir')}/%{lookup('gsajboss6::install::product')}-%{lookup('gsajboss6::install::version')}"

    
gsajboss6::dirs:
  root:
    path: "%{lookup('gsajboss6::rootdir')}"
  home:
    # analogous to CATALINA_HOME for shared binary distribution
    path: &JBOSS_HOME
      "%{lookup('gsajboss6::install::destdir')}"
  # alternately and then detect array and glue
  # - *root_dir
  # - "jboss-eap-%{lookup('gsajboss6::install::version')}"
  module:
    path: "%{lookup('gsajboss6::install::destdir')}/modules"
    # alternatively /usr/local/jboss/modules?


gsajboss6::instance::dirs:
  base:
    path: &JBOSS_BASE
      "%{lookup('gsajboss6::install::destdir')}/standalone"
  deploy:
    path: "%{lookup('gsajboss6::install::destdir')}/standalone/deployments"
  conf:
    path: "%{lookup('gsajboss6::install::destdir')}/standalone/configuration"
  log:
    path: "%{lookup('gsajboss6::install::destdir')}/standalone/log"
  module:
    path: "%{lookup('gsajboss6::install::destdir')}/standalone/modules"
  
    
#gsajboss6::modules::version: XXX
#gsajboss6::modules::source: "%{lookup('buckets.software')}/jboss"
#sajboss6::modules::destdir



#TODO
#gsajboss6::keystores::source: "%{lookup('buckets.conf')}/jboss"
#gsajboss6::keystores::dest: 
# gsajboss6::keystores::keystore:
  # source:
  # path:
  # mode:
# gsajboss6::keystores::truststore:
  # source:
  # path:
  # mode:
  
#FIXME this is a major hack
gsajboss6::java::version: 8
gsajboss6::java::source: "%{lookup('buckets.software')}/java"
gsajboss6::java::package: ''
gsajboss6::java::file: server-jre-8u161-linux-x64.tar.gz
# should match package or file contents
gsajboss6::java::destdir: jdk1.8.0_161



# interesting idea; https://github.com/grasmash/yaml-expander
# https://stackoverflow.com/questions/2063616/how-to-reference-a-yaml-setting-from-elsewhere-in-the-same-yaml-file
#jboss_dir: ${gsajboss6.base_dir}/jboss also
#
#TODO update manifests to call isInstance?(Array) then join(..., $facts['separator']) on array
  # - *root_dir
  # - "jboss-%{lookup('gsajboss6::jboss_version')}"

#gsajboss6::java_dir: "%{lookup('gsajboss6::base_dir')}/java/%{lookup('gsajboss6::java_version')}"
